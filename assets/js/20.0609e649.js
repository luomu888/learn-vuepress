(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{907:function(s,t,a){"use strict";a.r(t);var e=a(17),v=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"入门篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#入门篇"}},[s._v("#")]),s._v(" 入门篇")]),s._v(" "),a("h2",{attrs:{id:"sql和nosql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sql和nosql"}},[s._v("#")]),s._v(" SQL和NoSQL")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th"),s._v(" "),a("th",[s._v("SQL")]),s._v(" "),a("th",[s._v("NoSQL")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("结构")]),s._v(" "),a("td",[s._v("结构（主键，外键，自增）")]),s._v(" "),a("td",[s._v("非结构化")])]),s._v(" "),a("tr",[a("td",[s._v("SQL语句")]),s._v(" "),a("td",[s._v("是")]),s._v(" "),a("td",[s._v("不是")])]),s._v(" "),a("tr",[a("td",[s._v("存储")]),s._v(" "),a("td",[s._v("磁盘")]),s._v(" "),a("td",[s._v("内存")])]),s._v(" "),a("tr",[a("td",[s._v("关联")]),s._v(" "),a("td",[s._v("关联（表和表主键有联系，关系型数据库）")]),s._v(" "),a("td",[s._v("非关联，非关系型数据库")])]),s._v(" "),a("tr",[a("td",[s._v("性能")]),s._v(" "),a("td",[s._v("不好")]),s._v(" "),a("td",[s._v("好")])]),s._v(" "),a("tr",[a("td",[s._v("安全性，一致性")]),s._v(" "),a("td",[s._v("好")]),s._v(" "),a("td",[s._v("不好")])])])]),s._v(" "),a("h2",{attrs:{id:"redis特征"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis特征"}},[s._v("#")]),s._v(" Redis特征")]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("remote dictionary server")]),s._v("（远程字典服务器）")])]),s._v(" "),a("ul",[a("li",[s._v("主从集群、分片集群")]),s._v(" "),a("li",[s._v("支持多客户端（Java、c、Python）等")]),s._v(" "),a("li",[s._v("原子性")]),s._v(" "),a("li",[s._v("内存存储")]),s._v(" "),a("li",[s._v("数据持久化（AOF、RDB）")]),s._v(" "),a("li",[s._v("键值对\n"),a("ul",[a("li",[s._v("键：多数是字符串")]),s._v(" "),a("li",[s._v("值：5种基本数据类型（string，hash，set，sorted-set，list）")])])])]),s._v(" "),a("h2",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("tar -xzf redis-6.2.6.tar.gz")])]),s._v(" "),a("li",[a("p",[s._v("cd redis-6.2.6")])]),s._v(" "),a("li",[a("p",[s._v("make && make install")])]),s._v(" "),a("li",[a("p",[s._v("修改配置")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("cp redis.conf redis.conf.bck")])]),s._v(" "),a("li",[a("p",[s._v("vim redis.conf")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[s._v("- bind 0.0.0.0\n- daemonize yes :后台运行\n- requirepass redis：密码redis\n")])])])])])]),s._v(" "),a("li",[a("p",[s._v("vi /etc/systemd/system/redis.service")]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("Unit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("redis-server")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("network.target")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("Service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("forking")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/usr/local/bin/redis-server /usr/local/src/redis-6.2.6/redis.conf")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("PrivateTmp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("true")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("Install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("multi-user.target")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("systemctl daemon-reload")])]),s._v(" "),a("li",[a("p",[s._v("systemctl enable redis：开机自启")])])]),s._v(" "),a("h2",{attrs:{id:"redis常见命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis常见命令"}},[s._v("#")]),s._v(" Redis常见命令")]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("luo:user:1 luo:product:1")]),s._v("：luo项目下有user和商品表，编号都为1")])]),s._v(" "),a("p",[a("code",[s._v("select")]),s._v("0：切换数据库")]),s._v(" "),a("p",[a("code",[s._v("TTL")]),s._v("：time to life")]),s._v(" "),a("ul",[a("li",[s._v("-1：永久")]),s._v(" "),a("li",[s._v("-2：失效")])]),s._v(" "),a("p",[a("strong",[s._v("string")]),s._v("：简单的入门")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("setnx")]),s._v("：不存在添加，存在什么都不管（和set区别是存在修改）")])]),s._v(" "),a("p",[a("strong",[s._v("hash")]),s._v("：取到JSON字符串中的字段，修改字段值")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("hset key field value")]),s._v("：即key下有键值对")])]),s._v(" "),a("p",[a("strong",[s._v("list")]),s._v("：队列和栈的实现")]),s._v(" "),a("ul",[a("li",[s._v("队列：先进先出，两个门（左进右出，右进左出）")]),s._v(" "),a("li",[s._v("栈：先进后出，一个门（左进左出，右进右出）")]),s._v(" "),a("li",[s._v("lpush lpop rpush rpop")]),s._v(" "),a("li",[s._v("blpush blpop")]),s._v(" "),a("li",[a("code",[s._v("BLPOP")]),s._v("：\n"),a("ul",[a("li",[s._v("B："),a("code",[s._v("block")]),s._v("阻塞")]),s._v(" "),a("li",[s._v("L："),a("code",[s._v("left")]),s._v("左侧")])])]),s._v(" "),a("li",[s._v("语法：key 链表（1 2 3）")]),s._v(" "),a("li",[s._v("场景：点赞列表，评论列表")])]),s._v(" "),a("p",[a("strong",[s._v("set")]),s._v("：好友，朋友的好友和我的好友 相同数")]),s._v(" "),a("ul",[a("li",[s._v("交集 sinter")]),s._v(" "),a("li",[s._v("差集 sdiff("),a("code",[s._v("different")]),s._v(")")]),s._v(" "),a("li",[s._v("并集 "),a("code",[s._v("sunion")])]),s._v(" "),a("li",[s._v("语法：key 集合（1 2 3）")])]),s._v(" "),a("p",[a("strong",[s._v("sortedSet")]),s._v("：类似TreeSet，默认升序排序，可排序，使用场景排行榜")]),s._v(" "),a("ul",[a("li",[s._v("zrevrange 0 2：排名前三人数\n"),a("ul",[a("li",[s._v("z的后面添加rev，即降序")]),s._v(" "),a("li",[s._v("rev："),a("code",[s._v("reverse")]),s._v("反转")])])]),s._v(" "),a("li",[a("code",[s._v("zrank")]),s._v("：查看单个排名")]),s._v(" "),a("li",[a("code",[s._v("zscore")]),s._v("：查看单个分数")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220712215954448.png",alt:"image-20220712215954448"}})]),s._v(" "),a("h2",{attrs:{id:"redis的java客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis的java客户端"}},[s._v("#")]),s._v(" Redis的Java客户端")]),s._v(" "),a("p",[s._v("Jedis：")]),s._v(" "),a("ul",[a("li",[s._v("命令操作，")]),s._v(" "),a("li",[s._v("线程不安全，使用redis连接池（并发）")]),s._v(" "),a("li",[s._v("直接学springdataRedis")])]),s._v(" "),a("p",[s._v("SpringDataRedis")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("依赖")]),s._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!--Redis依赖--\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.springframework.boot"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("spring-boot-starter-data-redis"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!--连接池依赖--\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.apache.commons"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("commons-pool2"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("配置yaml")]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("redis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.111.130\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lettuce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-active")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#最大活跃")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-idle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#最大空闲")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("min-idle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#最小空闲")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-wait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#最大等待时间")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("普通RedisTemplate：可读性差")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220713210955232.png",alt:"image-20220713210955232"}})])]),s._v(" "),a("li",[a("p",[s._v("自定义RedisTemplate：多出class字节码，标识那个对象")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220713211037953.png",alt:"image-20220713211037953"}})])]),s._v(" "),a("li",[a("p",[s._v("解决：注入stringredisTemplate，key、value都是字符串，所以添加前把对象转字符串，获取结果把字符串转对象")])]),s._v(" "),a("li",[a("p",[s._v("ObjectMapper：JSON工具")]),s._v(" "),a("ul",[a("li",[s._v("writeValueAsString：对象->字符串")]),s._v(" "),a("li",[s._v("readValue：字符串->对象")])]),s._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.codehaus.jackson"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("jackson-mapper-asl"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1.9.13"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])])])]),s._v(" "),a("h1",{attrs:{id:"企业篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#企业篇"}},[s._v("#")]),s._v(" 企业篇")]),s._v(" "),a("h2",{attrs:{id:"redis实现共享token登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis实现共享token登录"}},[s._v("#")]),s._v(" Redis实现共享token登录")]),s._v(" "),a("blockquote",[a("p",[s._v("注意：使用Redis一定要记得设置有效期，否则浪费内存")])]),s._v(" "),a("p",[a("code",[s._v("session")]),s._v("配合"),a("code",[s._v("cookie")]),s._v("实现登录：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("session")]),s._v("存验证码")]),s._v(" "),a("li",[s._v("判断验证码，根据手机号查询用户\n"),a("ul",[a("li",[s._v("用户不存在，创建新用户（无需注册）")]),s._v(" "),a("li",[s._v("存在和不存在最后存入"),a("code",[s._v("session")]),s._v("都是数据库存在的")])])]),s._v(" "),a("li",[s._v("用户信息存入"),a("code",[s._v("session")])]),s._v(" "),a("li",[s._v("校验登录，请求携带"),a("code",[s._v("cookie")]),s._v("，cookie中用"),a("code",[s._v("sessionid")]),s._v("，"),a("code",[s._v("Tomcat")]),s._v("自动根据"),a("code",[s._v("sessionid")]),s._v("找到"),a("code",[s._v("session")])]),s._v(" "),a("li",[s._v("从session中拿到用户信息，判断用户是否存在，没有则拦截")])]),s._v(" "),a("p",[s._v("session：java代码保存，"),a("code",[s._v("key")]),s._v("自定义，"),a("code",[s._v("value")]),s._v("用户信息\ncookie：key是"),a("code",[s._v("jseesionid")]),s._v("value是jseesionid 的值")]),s._v(" "),a("p",[s._v("每个session都有一个唯一的sessionid\nsessionid自动写到cookie")]),s._v(" "),a("p",[s._v("请求时带上自动带上cookie，然后sessionid也跟上，自动找到session")]),s._v(" "),a("p",[s._v("Tomcat帮我们处理sessionid自动操作")]),s._v(" "),a("p",[s._v("Redis实现共享"),a("code",[s._v("token")]),s._v("登录：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("登录使用session的问题：多台Tomcat不存在session共享")])]),s._v(" "),a("li",[a("p",[s._v("解决：数据共享，内存，key value（hash）-------\x3e"),a("code",[s._v("Redis")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220714105137508.png",alt:"image-20220714105137508"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220714093259472.png",alt:"image-20220714093259472"}})])])]),s._v(" "),a("p",[s._v("登录状态：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("用户登录校验使用拦截器，不同controller就不需要单独写校验，拦截器在"),a("code",[s._v("controller")]),s._v("之前执行，统一写到拦截器判断校验")])]),s._v(" "),a("li",[a("p",[s._v("平常注册完后登录状态一直在")])]),s._v(" "),a("li",[a("p",[s._v("没有登录之前拦截请求其他页面，登录后就不管，一直有效，随便访问页面")])]),s._v(" "),a("li",[a("p",[s._v("这次拦截判断登录状态是否有效，一直没有请求其他页面，时间到后需要重新登录")])]),s._v(" "),a("li",[a("p",[s._v("关键是判断"),a("code",[s._v("ThreadLocal")]),s._v("是否有用户，没有用户则拦截请求")])]),s._v(" "),a("li",[a("p",[s._v("一开始登录没有用户，所以第一个不需要拦截，第二个拦截器才需要判断用户是否存在进行拦截")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220714104819570.png",alt:"image-20220714104819570"}})]),s._v(" "),a("p",[s._v("技巧：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("拦截器到的用户信息存到threadlocal方便controller使用")])]),s._v(" "),a("li",[a("p",[s._v("401未授权")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("BeanUtil.copyProperties")]),s._v("：对象属性填充")])]),s._v(" "),a("li",[a("p",[s._v("使用redis代替session")])]),s._v(" "),a("li",[a("p",[s._v("请求带cookie，cookie带sessionid，根据sessionid找到session")])]),s._v(" "),a("li",[a("p",[s._v("使用token原因：token还需要返回给前端，如果使用手机号用泄露的风险")])]),s._v(" "),a("li",[a("p",[s._v("定义为常量防止之后写错")])]),s._v(" "),a("li",[a("p",[s._v("自定义类不能使用@resource和@Autowire注入，可以使用构造方法注入，然后谁使用该类，把对象传进来")])]),s._v(" "),a("li",[a("p",[s._v("用户信息不能泄露，前端用户信息页面展示只需要少量，所以定义vo类")])])]),s._v(" "),a("p",[s._v("@Resource 和 @Autowire区别")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th"),s._v(" "),a("th",[s._v("resource")]),s._v(" "),a("th",[s._v("Autowire")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("类型")]),s._v(" "),a("td",[s._v("byname")]),s._v(" "),a("td",[s._v("bytype（接口对应一个实现类使用）")])]),s._v(" "),a("tr",[a("td",[s._v("指定方式")]),s._v(" "),a("td",[s._v("name指定")]),s._v(" "),a("td",[s._v("qualifier")])])])]),s._v(" "),a("p",[s._v("学完项目token，再去看Javaguide的token")]),s._v(" "),a("ul",[a("li",[s._v("权限验证")]),s._v(" "),a("li",[s._v("cookie自带sessionid，容易遭到攻击，因为你点击黑客连接，cookie被他拿到")]),s._v(" "),a("li",[s._v("而"),a("code",[s._v("token")]),s._v("没有存入cookie，存到会话存储空间")]),s._v(" "),a("li",[s._v("http是无状态协议，需要使用cookie和session记录状态")])]),s._v(" "),a("h2",{attrs:{id:"查询缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询缓存"}},[s._v("#")]),s._v(" 查询缓存")]),s._v(" "),a("p",[s._v("速度：CPU>内存>磁盘")]),s._v(" "),a("p",[s._v("而CPU需要从内存或磁盘取数据才能执行，所以有了缓存，提前把数据存入到CPU的缓存中，无需重新获取，性能提升")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715182603493.png",alt:"image-20220715182603493"}})]),s._v(" "),a("h3",{attrs:{id:"redis缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis缓存"}},[s._v("#")]),s._v(" Redis缓存")]),s._v(" "),a("p",[s._v("浏览器：img图片")]),s._v(" "),a("p",[s._v("Tomcat：应用层缓存，redis")]),s._v(" "),a("p",[s._v("数据库缓存：索引缓存，索引查询速度快")]),s._v(" "),a("p",[s._v("数据库数据最终还是到磁盘或CPU差，所以还有CPU缓存（多级缓存），磁盘缓存")]),s._v(" "),a("p",[s._v("缓存数据一致性问题，解决问题需要复杂代码，维护问题，硬件问题")]),s._v(" "),a("p",[s._v("缓存也可以不使用，只要你能等，兜底也加"),a("code",[s._v("TTL")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715183056310.png",alt:"image-20220715183056310"}})]),s._v(" "),a("h3",{attrs:{id:"redis缓存问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis缓存问题"}},[s._v("#")]),s._v(" Redis缓存问题")]),s._v(" "),a("p",[s._v("更新：")]),s._v(" "),a("ul",[a("li",[s._v("自动：内存不足自动淘汰")]),s._v(" "),a("li",[s._v("时间到后剔除：设置TTL")]),s._v(" "),a("li",[s._v("主动：更新数据库同时，把缓存更新")])]),s._v(" "),a("p",[s._v("主动策略：")]),s._v(" "),a("ul",[a("li",[s._v("修改数据库，把缓存更新，数据库最新")]),s._v(" "),a("li",[s._v("修改缓存，异步把数据库更新，缓存最新")]),s._v(" "),a("li",[s._v("我什么都不管，我调用服务来解决")])]),s._v(" "),a("p",[s._v("删除缓存还是更新缓存：删除好，因为数据库可能一直修改，没查询，缓存也跟着更新，导致无效写操作多")]),s._v(" "),a("p",[s._v("线程安全问题：先删缓存后操作数据库")]),s._v(" "),a("ul",[a("li",[s._v("删除缓存")]),s._v(" "),a("li",[s._v("第二个线程查询缓存没有，把数据库10放到缓存")]),s._v(" "),a("li",[s._v("第一个线程好了，更新数据库，数据库20，缓存10")])]),s._v(" "),a("p",[s._v("事务：单体，缓存操作和数据库放到一块")]),s._v(" "),a("p",[s._v("先操作数据库，然后删除缓存，操作数据库时间长，删除缓存"),a("code",[s._v("redis")]),s._v("基于内存快，所以数据一致性高")]),s._v(" "),a("p",[s._v("不同步原因：缓存失效，查询"),a("code",[s._v("redis")]),s._v("未命中，查询数据库同时，另一个线程更新数据库，删除缓存，写入缓存是第一个查询的老数据")]),s._v(" "),a("p",[s._v("写入缓存微妙级别，把数据库更新和缓存删除不太可能（概率低）")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715113717881.png",alt:"image-20220715113717881"}})]),s._v(" "),a("p",[s._v("缓存穿透：请求数据库不存在的值，null，一直请求，都打到数据库，黑客不怀好意访问")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("查询数据库不存在，返回"),a("code",[s._v('""')]),s._v("空值存入"),a("code",[s._v("redis")]),s._v("缓存")])]),s._v(" "),a("li",[a("p",[s._v("布隆过滤：布隆不存在，直接返回")])]),s._v(" "),a("li",[a("p",[s._v("预防：用户权限，参数校验，热点参数限流，id不规则性，防止被猜测")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715201727996.png",alt:"image-20220715201727996"}})])])]),s._v(" "),a("p",[s._v("缓存雪崩：大量key失效")]),s._v(" "),a("ul",[a("li",[s._v("设置TTL无规则")]),s._v(" "),a("li",[s._v("降级限流")]),s._v(" "),a("li",[s._v("多级缓存")])]),s._v(" "),a("p",[s._v("缓存击穿：缓存失效，重建过程复杂，花费时间长，许多请求")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("互斥锁，只能有一个重建")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715201815461.png",alt:"image-20220715201815461"}})])]),s._v(" "),a("li",[a("p",[s._v("逻辑过期：即拿到锁的重建，其他返回旧数据，添加"),a("code",[s._v("expire")]),s._v("，用于缓存失效重建过程判断缓存还生效（善意的谎言）")])]),s._v(" "),a("li",[a("p",[s._v("注意：缓存没命中，返回空不是旧数据，因为不可能为空，"),a("code",[s._v("expire")]),s._v("一直在，是人工提前设置，活动结束手动删除")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715201843592.png",alt:"image-20220715201843592"}})])])]),s._v(" "),a("p",[s._v("缓存击穿：关键是自定义的假过期，我传入10秒，10秒后过期")]),s._v(" "),a("p",[a("code",[s._v("redisData.getExpireTime().isAfter(LocalDateTime.now())")]),s._v("：判断在当前时间后，不在过期，过期，开启独立线程执行数据重建，创建shop和expire载入redis，释放锁，然后返回旧数据，下次进来就可以获取新数据")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("queryWithBreakDown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" preKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ID")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Class")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Function")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" dbCallBack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeUnit")]),s._v(" unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Shop")]),s._v(" shop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redisCache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("queryWithBreakDown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CACHE_SHOP_KEY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Shop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" CACHE_SHOP_TTL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeUnit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SECONDS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])])]),a("p",[a("code",[s._v("<R,ID>")]),s._v("：泛型")]),s._v(" "),a("p",[a("code",[s._v("function")]),s._v("：函数，不确定类型，由调用者执行函数，")]),s._v(" "),a("p",[a("code",[s._v("Class<R> type")]),s._v("：指定R的类型")]),s._v(" "),a("p",[s._v("布隆存在误判")]),s._v(" "),a("p",[s._v("封装工具类：函数编程思想")]),s._v(" "),a("p",[s._v("锁有规定id")]),s._v(" "),a("p",[s._v("缓存穿透：")]),s._v(" "),a("ul",[a("li",[s._v("问题：访问不存在的数据，直接打到"),a("code",[s._v("Redis")])]),s._v(" "),a("li",[s._v("解决：\n"),a("ul",[a("li",[s._v('第一次，数据库查询为空，然后缓存设置""，设置时间')]),s._v(" "),a("li",[s._v('第二次，访问数据存在，值""，所以直接返回')]),s._v(" "),a("li",[s._v('流程；判断数据是否存在，存在判断是否为""，否则返回数据；redis为null，查询数据库，数据库为空，缓存设置""，返回结果""；否则数据库查出来数据放到redis，返回数据')])])])]),s._v(" "),a("p",[s._v("缓存雪崩：")]),s._v(" "),a("ul",[a("li",[s._v("问题：大量的"),a("code",[s._v("key")]),s._v("同时失效")]),s._v(" "),a("li",[s._v("解决：key设置时间无规则；降级限流，热点参数；权限管理")])]),s._v(" "),a("p",[s._v("缓存击穿：")]),s._v(" "),a("ul",[a("li",[s._v("问题："),a("code",[s._v("key")]),s._v("恰好失效，高并发请求过来，重建数据复杂")]),s._v(" "),a("li",[s._v("解决：\n"),a("ul",[a("li",[s._v("互斥锁：redis数据存在，直接返回；不存在，获取锁，获取锁失败，睡眠后重新请求（递归）；获取锁成功，查询数据，把数据写入redis缓存，关闭锁，返回数据")]),s._v(" "),a("li",[s._v("逻辑过期：redis数据为命中，返回null，因为活动前人为设置数据，一直存在，假过期，访问不存在，那么就是不存在；redis命中，判断是否过期；未过期返回数据；过期获取锁，获取锁失败，返回旧数据；获取锁成功，开启独立线程，查询数据并设置"),a("code",[s._v("expire")]),s._v("时间，最后添加到"),a("code",[s._v("Redis")]),s._v("缓存，关闭锁，下次访问就存在")])])])]),s._v(" "),a("h2",{attrs:{id:"优惠价秒杀-旧"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优惠价秒杀-旧"}},[s._v("#")]),s._v(" 优惠价秒杀（旧）")]),s._v(" "),a("blockquote",[a("p",[s._v("添加特价劵")]),s._v(" "),a("p",[s._v("看门狗：库存是否充足，一人一单，订单是否存在")])]),s._v(" "),a("p",[s._v("思路：获取锁，添加线程标识类似主键，给锁设置超时时间，阻塞自动释放锁；没有阻塞执行业务")]),s._v(" "),a("p",[s._v("业务：查询优惠价信息，判断秒杀开始和结束时间，库存，优惠券"),a("code",[s._v("id")]),s._v("和用户"),a("code",[s._v("id")]),s._v("判断订单号是否存在")]),s._v(" "),a("p",[s._v("释放锁，判断标识是否自己，此时必须保证判断标识和删除"),a("code",[s._v("key")]),s._v("两个动作原子性，所以使用"),a("code",[s._v("lua")]),s._v("脚本")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220717204318686.png",alt:"image-20220717204318686"}})]),s._v(" "),a("p",[s._v("注意订单号问题（重点）：订单号保持许多无规律，所以不能使用主键唯一性，如果没有许多订单号，使用数据库主键自增，不会出现很多超卖问题，可以使用下面规则判断库存，判断订单")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220717164427191.png",alt:"image-20220717164427191"}})]),s._v(" "),a("p",[s._v("具体实现：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("喜欢反向操作，不行直接退出")])]),s._v(" "),a("li",[a("p",[s._v("订单id：生成一个全局唯一"),a("code",[s._v("id")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("时间戳=当前时间-前"),a("code",[s._v("69")]),s._v("年")])]),s._v(" "),a("li",[a("p",[s._v("向左移"),a("code",[s._v("32")]),s._v("位，留32位给一天使用")])]),s._v(" "),a("li",[a("p",[s._v("或运算")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 时间戳")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" INIT_TIME"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1640995200L")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LocalDateTime")]),s._v(" now "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LocalDateTime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" nowTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("toEpochSecond")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ZoneOffset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" l "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" nowTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" INIT_TIME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" stringRedisTemplate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForValue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("increment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"incr:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" keyPreFix "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('":"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" l"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v("DIGIT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])])])])])]),s._v(" "),a("p",[s._v("集群下：每个"),a("code",[s._v("jvm")]),s._v("都有自己的锁，锁监视器不一样")]),s._v(" "),a("p",[a("code",[s._v("redis")]),s._v("的"),a("code",[s._v("setnx")]),s._v("分布式锁：")]),s._v(" "),a("ul",[a("li",[s._v("问题：线程1获取锁成功，执行业务，业务阻塞，TTL到期，删除锁，第二个线程执行，第一个好了，删除锁，第二个线程还不知道锁被删除，第三个线程来了，看见第一个线程把锁删了，所以第三个 线程也获取锁成功，同时出现了线程2和3执行业务")])]),s._v(" "),a("p",[s._v("释放锁时被别人锁删除")]),s._v(" "),a("p",[s._v("垃圾回收"),a("code",[s._v("fullGC")]),s._v("阻塞所有代码")]),s._v(" "),a("p",[s._v("判断和释放锁两个动作，保证两个动作原子性")]),s._v(" "),a("p",[s._v("原子性：事务，"),a("code",[s._v("lua")]),s._v("脚本确保原子性")]),s._v(" "),a("p",[a("code",[s._v("classpathresource")])]),s._v(" "),a("p",[s._v("分布式锁添加标识，标识成功后进入删除，还没来得及删除锁，阻塞，别人获取锁，网络好了，删除锁，不用重新判断标识，所以要保证标识和删除动作的原子性")]),s._v(" "),a("p",[s._v("Redis-lua：一定是"),a("code",[s._v("KEYS")]),s._v("和"),a("code",[s._v("ARGV")]),s._v("大写，小写报错")]),s._v(" "),a("div",{staticClass:"language-lua extra-class"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 判断标识是否一致")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("KEYS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("ARGV"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"del"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("KEYS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])])]),a("p",[s._v("一个用户加一把锁 一个用户不能加多个锁")]),s._v(" "),a("p",[a("code",[s._v("userid.toString()")]),s._v("，底层tostring方法是"),a("code",[s._v("new string")]),s._v("，所以还不是同一个对象，使用"),a("code",[s._v("userid.toString().intern()")])]),s._v(" "),a("p",[s._v("事务尚未提交，事务提交后释放锁")]),s._v(" "),a("p",[s._v("事务失效：解决，需要拿到事务代理对象"),a("code",[s._v("AopContext.currentProxy()")])]),s._v(" "),a("p",[s._v("启动类添加代理对象暴露："),a("code",[s._v("@EnableAspectJAutoProxy(exposeProxy=true)")]),s._v("，添加依赖")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220716132543111.png",alt:"image-20220716132543111"}})]),s._v(" "),a("p",[s._v("不可重入，调用同一把锁，A调用锁，A里面执行B需要调用同一把锁，失败，因为A还在用，B没结束，导致A没结束，死锁")]),s._v(" "),a("p",[s._v("功能扩展：概率极低分布式锁优化，可以跳过")]),s._v(" "),a("p",[s._v("前面学习是懂原理，面试问，以后开发使用"),a("code",[s._v("Redis")]),s._v("框架"),a("code",[s._v("redisson")]),s._v("，有许多好用的锁")]),s._v(" "),a("p",[s._v("redisson：")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RedisConfig")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RedissonClient")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("redissonClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Config")]),s._v(" config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("useSingleServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setAddress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"redis://192.168.111.130:6379"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setPassword")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"redis"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Redisson")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 锁对象")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RLock")]),s._v(" lock "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redissonClient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getLock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"order:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 尝试获取")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" isLock "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tryLock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200L")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeUnit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SECONDS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 释放")]),s._v("\nlock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("unlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("秒杀的锁："),a("code",[s._v("order:userId")]),s._v("\n订单id：\nkey："),a("code",[s._v("incr:order:时间戳")]),s._v("\nvalue：递增 1 2 3 4 5\n最后数据库返回的订单id，"),a("code",[s._v("L<<digit | value")]),s._v("，L左移32位，剩下32给"),a("code",[s._v("value")]),s._v("（一天），L=当前时间戳-69年时间戳")]),s._v(" "),a("p",[s._v("商品key："),a("code",[s._v("cache:shop:shopid")])]),s._v(" "),a("p",[s._v("自定义的秒杀锁：\nkey："),a("code",[s._v("lock:order:userId")]),s._v("\n唯一标识"),a("code",[s._v("value：UUID")]),s._v("随机数+当前线程id "),a("code",[s._v("ThreadID")])]),s._v(" "),a("h2",{attrs:{id:"优化秒杀-常用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化秒杀-常用"}},[s._v("#")]),s._v(" 优化秒杀（常用）")]),s._v(" "),a("p",[s._v("参考登录：数据库把用户取出来，拿到手机号，生成随机"),a("code",[s._v("token")]),s._v("，然后存入Redis")]),s._v(" "),a("p",[a("code",[s._v("@PostConstruct")]),s._v("：当前类初始化完毕后执行")]),s._v(" "),a("p",[s._v("没有消息阻塞"),a("code",[s._v("BLPOP")])]),s._v(" "),a("p",[a("code",[s._v("xread count 1 streams users 0：")]),s._v("\ncount 1 ：读取数量\nstreams users：哪个streams，指队列\n0：代表从第一个消息开始\n$：代表从最新消息开始，中间漏读")]),s._v(" "),a("p",[s._v("// 创建组，队列stream.orders\n"),a("code",[s._v("xgroup create stream.orders g1 0 mkstream")])]),s._v(" "),a("ul",[a("li",[s._v("stream.orders ：队列")]),s._v(" "),a("li",[s._v("g1：组")])]),s._v(" "),a("p",[s._v("// 添加消费者\n"),a("code",[s._v("xgroup createconsumer stream.orders g1 c1")])]),s._v(" "),a("ul",[a("li",[s._v("stream.orders ：队列")]),s._v(" "),a("li",[s._v("g1：组")]),s._v(" "),a("li",[s._v("c1：消费者")])]),s._v(" "),a("p",[s._v("最完整的秒杀流程：")]),s._v(" "),a("blockquote",[a("p",[s._v("思路：执行脚本，脚本返回值0 1 2 ，为0则直接返回订单id；类启动初始化完成后，使用@PostConstruct标注的方法立刻执行，所以里面独立线程调用预处理订单方法；预处理指从消息队列获取订单消息，判断是否存在，存在创建订单（调用真正和数据库打交道的方法，即库存-1，保存订单记录.），确认消息执行；异常执行另一个方法，从pending-list获取消息，使用0，获取最初未被消费和确认消息；创建订单：获取锁对象，尝试获取锁，判断订单是否存在数据库，不存在，扣减库存，保存订单")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("开启独立线程")])]),s._v(" "),a("li",[a("p",[s._v("@PostConstruct：在类初始化完成后执行")])]),s._v(" "),a("li",[a("p",[s._v("获取消息队列订单消息，创建订单，执行xack确认消息被消费，异常的话重新执行")]),s._v(" "),a("ul",[a("li",[s._v("创建一个新方法执行（对）：使用"),a("code",[s._v("streams stream.orders 0")]),s._v("，遗漏的消息，即pending-list中的第一个消息")]),s._v(" "),a("li",[s._v("递归调用本方法（错）：使用"),a("code",[s._v("streams stream.orders >")]),s._v("  下一个未消费消息")])])]),s._v(" "),a("li",[a("p",[s._v("创建订单：")]),s._v(" "),a("ul",[a("li",[s._v("用户id，秒杀券id")]),s._v(" "),a("li",[s._v("获取锁对象，尝试获取锁")]),s._v(" "),a("li",[s._v("查询订单是否存在")]),s._v(" "),a("li",[s._v("不存在扣减库存，保存订单")]),s._v(" "),a("li",[s._v("释放锁")])])]),s._v(" "),a("li",[a("p",[s._v("获取用户id，随机订单id")])]),s._v(" "),a("li",[a("p",[s._v("执行lua脚本")])]),s._v(" "),a("li",[a("p",[s._v("获取结果，判断结果 0可以返回订单id，还没操作数据库，只是立刻返回，独立线程执行数据库；否则库存不足或不能重复下单")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220719114417013.png",alt:"image-20220719114417013"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220719204132290.png",alt:"image-20220719204132290"}})])]),s._v(" "),a("li",[a("p",[a("code",[s._v("seckill.lua")]),s._v("：")]),s._v(" "),a("ul",[a("li",[s._v("参数：优惠券id，用户id，订单id")]),s._v(" "),a("li",[s._v("key：库存key，订单key")]),s._v(" "),a("li",[s._v("判断库存是否充足")]),s._v(" "),a("li",[s._v("判断用户是否下单")]),s._v(" "),a("li",[s._v("扣库存（Redis）")]),s._v(" "),a("li",[s._v("下单（保存用户信息到redis）")]),s._v(" "),a("li",[s._v("发送消息到队列")])])])]),s._v(" "),a("p",[a("code",[s._v('setSql("stock=stock-1")')])]),s._v(" "),a("p",[s._v("-- 2.数据key")]),s._v(" "),a("p",[s._v("-- 2.1.库存key")]),s._v(" "),a("p",[a("code",[s._v("local stockKey = 'seckill:stock:' .. voucherId")])]),s._v(" "),a("p",[s._v("-- 2.2.订单key")]),s._v(" "),a("p",[a("code",[s._v("local orderKey = 'seckill:order:' .. voucherId")])]),s._v(" "),a("h2",{attrs:{id:"点赞"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#点赞"}},[s._v("#")]),s._v(" 点赞")]),s._v(" "),a("blockquote",[a("p",[s._v("后端点赞控制主要是"),a("code",[s._v("isLike")]),s._v("字段，"),a("code",[s._v("true")]),s._v("点赞，"),a("code",[s._v("false")]),s._v("未点赞")]),s._v(" "),a("p",[s._v("点赞功能：添加多个表，记录点赞用户（操作数据库，太重了）")]),s._v(" "),a("p",[s._v("解决："),a("code",[s._v("redis")]),s._v("，点赞集合，"),a("code",[s._v("set")]),s._v("，集合存用户id，唯一性")])]),s._v(" "),a("p",[s._v("发表博客：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("post")]),s._v("请求")]),s._v(" "),a("li",[s._v("参数实体类，"),a("code",[s._v("@RequestBody")])])]),s._v(" "),a("p",[s._v("图片上传："),a("code",[s._v("multipartfile")]),s._v("多部分文件")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("getOriginalFilename")]),s._v("：获取文件原始名称")]),s._v(" "),a("li",[s._v("生成新文件名，方便统一管理：自定义方法实现")]),s._v(" "),a("li",[a("code",[s._v("transferTo")]),s._v("：保存图片到本地磁盘，即"),a("code",[s._v("nginx")]),s._v("下的项目")]),s._v(" "),a("li",[s._v("返回结果")])]),s._v(" "),a("p",[s._v("实体类：字段可以多不可以少")]),s._v(" "),a("p",[s._v("博客类：包含用户id，名字，图片（userDTO），字段设置不存在")]),s._v(" "),a("p",[s._v("根据博客id查询博客")]),s._v(" "),a("ul",[a("li",[s._v("注意：博客存在，展示需要查询博客底下相关用户，是否被点赞")]),s._v(" "),a("li",[s._v("点赞key："),a("code",[s._v("BLOG_LIKED_KEY+blogId")])]),s._v(" "),a("li",[a("code",[s._v("field")]),s._v("字段："),a("code",[s._v("userID")]),s._v("值")]),s._v(" "),a("li",[a("code",[s._v("score")]),s._v("：时间戳")])]),s._v(" "),a("p",[s._v("根据博客查询博客用户"),a("code",[s._v("queryBlogUser(Blog blog)")])]),s._v(" "),a("ol",[a("li",[s._v("取出博客用户id")]),s._v(" "),a("li",[s._v("根据用户id查询用户")]),s._v(" "),a("li",[s._v("设置博客关于用户的字段")])]),s._v(" "),a("p",[s._v("根据博客类判断用户是否点赞"),a("code",[s._v("isBlogLiked(Blog blog)")])]),s._v(" "),a("ol",[a("li",[s._v("获取当前用户")]),s._v(" "),a("li",[s._v("获取用户id")]),s._v(" "),a("li",[s._v("拼接key，查询redis的"),a("code",[s._v("score")]),s._v("值是否存在")])]),s._v(" "),a("p",[s._v("当前用户点赞控制，点过在点-1：")]),s._v(" "),a("ul",[a("li",[s._v("获取当前用户id")]),s._v(" "),a("li",[s._v("查询Redis的score值")]),s._v(" "),a("li",[s._v("值为空，点赞，存入Redis")]),s._v(" "),a("li",[s._v("不为空，点赞数量-1，Redis删除")])]),s._v(" "),a("p",[s._v("获取点赞用户前5：")]),s._v(" "),a("ul",[a("li",[s._v("Redis的"),a("code",[s._v("range")]),s._v("查询前5的blog")]),s._v(" "),a("li",[s._v("解析结果中的用户id")]),s._v(" "),a("li",[s._v("遍历每个id查询用户")]),s._v(" "),a("li",[s._v("设置每个"),a("code",[s._v("userDTO")])]),s._v(" "),a("li",[s._v("返回userDTO集合")])]),s._v(" "),a("p",[s._v("注意：更新数据库，需要调用两次"),a("code",[s._v("update")]),s._v("方法")]),s._v(" "),a("h2",{attrs:{id:"关注"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关注"}},[s._v("#")]),s._v(" 关注")]),s._v(" "),a("p",[s._v("in(3,1)：1，3数据库id排序有问题；使用"),a("code",[s._v("order bt field(id,5,1)")]),s._v("，order by field(id,ids)，保证新发布显示在前")]),s._v(" "),a("p",[s._v("是否关注：")]),s._v(" "),a("ul",[a("li",[s._v("获取用户id")]),s._v(" "),a("li",[s._v("根据用户"),a("code",[s._v("id、followid")]),s._v("查询是否关注")])]),s._v(" "),a("p",[s._v("关注：Redis数据库类型使用set")]),s._v(" "),a("ul",[a("li",[s._v("用户id")]),s._v(" "),a("li",[a("code",[s._v("key：follows:+userId")])]),s._v(" "),a("li",[s._v("关注：\n"),a("ul",[a("li",[s._v("新增数据")]),s._v(" "),a("li",[s._v("保存到Redis，"),a("code",[s._v("value：followID")])])])]),s._v(" "),a("li",[s._v("取关：\n"),a("ul",[a("li",[s._v("根据用户id和跟随id删除数据库")]),s._v(" "),a("li",[s._v("删除Redis")])])])]),s._v(" "),a("p",[s._v("新增博客")]),s._v(" "),a("ul",[a("li",[s._v("获取当前用户")]),s._v(" "),a("li",[s._v("博客设置用户id字段后保存到数据库")]),s._v(" "),a("li",[s._v("根据用户id查询所有粉丝")]),s._v(" "),a("li",[s._v("用户粉丝id（实际是另一个用户id）")]),s._v(" "),a("li",[s._v("保存到Redis，"),a("code",[s._v("key=feed_key+userId，field博客id，value时间戳")])]),s._v(" "),a("li",[s._v("返回博客id")])]),s._v(" "),a("p",[s._v("查询共同关注：")]),s._v(" "),a("ul",[a("li",[s._v("用户id")]),s._v(" "),a("li",[a("code",[s._v('key1="follows"+userId')])]),s._v(" "),a("li",[a("code",[s._v('key2="follows"+id')]),s._v("，该id是查询某个用户id（实际也是用户id）")]),s._v(" "),a("li",[s._v("求交集")]),s._v(" "),a("li",[s._v("解析结果")]),s._v(" "),a("li",[s._v("返回"),a("code",[s._v("userDTO")]),s._v("集合")])]),s._v(" "),a("p",[s._v("拉：消息放到up住，粉丝要在拉过去，用完丢，要的时候在拉")]),s._v(" "),a("p",[s._v("推模式；直接把文章推送到用户，例微信公众号，读取延迟低")]),s._v(" "),a("p",[s._v("推拉模式：热点粉丝推，普通粉丝拉模式，拉模式读取延迟高")]),s._v(" "),a("p",[s._v("使用推：没有大V")]),s._v(" "),a("p",[s._v("数据有变化，排行榜，朋友圈消息，角标使用"),a("code",[s._v("sortedSet")]),s._v("，不使用list")]),s._v(" "),a("p",[s._v("offset要跳过上次查询第几个和最小一样的")]),s._v(" "),a("p",[a("code",[s._v("@RequestParam，defaultValue=“0”，require=false")]),s._v("，代表参数也可以没有")]),s._v(" "),a("p",[s._v("请求方式 请求路径 请求参数 返回值")]),s._v(" "),a("p",[s._v("滚动分页查询：")]),s._v(" "),a("ul",[a("li",[s._v("当前用户")]),s._v(" "),a("li",[s._v("查询Redis收件箱："),a("code",[s._v("ZREVRANGEBYSCORE key Max Min LIMIT offset count")])]),s._v(" "),a("li",[s._v("解析数据：偏移量、时间戳")]),s._v(" "),a("li",[s._v("遍历所有博客，查询跟博客相关点赞用户，查询是否被点赞")]),s._v(" "),a("li",[s._v("封装到"),a("code",[s._v("ScrollResult")]),s._v("并返回")])]),s._v(" "),a("h2",{attrs:{id:"附近商户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#附近商户"}},[s._v("#")]),s._v(" 附近商户")]),s._v(" "),a("blockquote",[a("p",[s._v("算法，所有实现"),a("code",[s._v("geo")]),s._v("底层原理：将经纬度转换为二进制的数字，利用某种编码转换成对应字符串")])]),s._v(" "),a("p",[s._v("是不是得提前把距离数据存入Redis：是，需要在测试类中提前添加")]),s._v(" "),a("p",[s._v("查询店铺类型+坐标：")]),s._v(" "),a("ul",[a("li",[s._v("判断是否需要坐标")]),s._v(" "),a("li",[s._v("from、end：分页参数")]),s._v(" "),a("li",[a("code",[s._v("key：SHOP_GEO_KEY+typeID")])]),s._v(" "),a("li",[s._v("距离5000，limit(end)")]),s._v(" "),a("li",[s._v("截取from~end："),a("code",[s._v("stream().skip(from).forEach(result->)")])]),s._v(" "),a("li",[s._v("map：键店铺id，值"),a("code",[s._v("distance")])]),s._v(" "),a("li",[s._v("返回shops集合")])]),s._v(" "),a("h2",{attrs:{id:"签到"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#签到"}},[s._v("#")]),s._v(" 签到")]),s._v(" "),a("p",[s._v("签到：")]),s._v(" "),a("ul",[a("li",[s._v("当前用户id")]),s._v(" "),a("li",[s._v("当前日期")]),s._v(" "),a("li",[a("code",[s._v("key=USER_SIGN_KEY+userId+keySuffix")]),s._v("（日期）")]),s._v(" "),a("li",[s._v("获取本月的第几天")]),s._v(" "),a("li",[s._v("写入Redis")])]),s._v(" "),a("p",[s._v("本月签到数量：")]),s._v(" "),a("ul",[a("li",[s._v("用户id")]),s._v(" "),a("li",[a("code",[s._v("key=USER_SIGN_KEY+userId+keySuffix")]),s._v("（日期）")]),s._v(" "),a("li",[s._v("获取本月的第几天")]),s._v(" "),a("li",[a("code",[s._v("BITFIELD sign:5:202203 GET u14 0")])]),s._v(" "),a("li",[s._v("获取结果第一位")]),s._v(" "),a("li",[s._v("遍历")])]),s._v(" "),a("h2",{attrs:{id:"uv"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#uv"}},[s._v("#")]),s._v(" UV")]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("UV(unique visitor)")]),s._v("：独立访客量，一个用户一个")]),s._v(" "),a("p",[a("code",[s._v("PV(page view)")]),s._v("：页面访问量，刷新当前页面访问量+1")]),s._v(" "),a("p",[a("code",[s._v("HyperLogLog")]),s._v("：存储内容大小永远小于16kb，小于0.81%误差，内存低到令人发指！")])]),s._v(" "),a("ul",[a("li",[s._v("准备大小1000数组")]),s._v(" "),a("li",[s._v("遍历1000000一百万")]),s._v(" "),a("li",[s._v("到1000覆盖之前数组，即下标从0开始")]),s._v(" "),a("li",[s._v("Redis统计数量")])]),s._v(" "),a("h1",{attrs:{id:"高级篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高级篇"}},[s._v("#")]),s._v(" 高级篇")]),s._v(" "),a("h2",{attrs:{id:"分布式缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分布式缓存"}},[s._v("#")]),s._v(" 分布式缓存")]),s._v(" "),a("p",[s._v("单点Redis问题：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("问题")]),s._v(" "),a("th",[s._v("解决")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("内存存储上限")]),s._v(" "),a("td",[s._v("分片集群，插槽机制")])]),s._v(" "),a("tr",[a("td",[s._v("数据丢失")]),s._v(" "),a("td",[s._v("持久化AOF和RDB")])]),s._v(" "),a("tr",[a("td",[s._v("并发")]),s._v(" "),a("td",[s._v("主从集群，读写分离")])]),s._v(" "),a("tr",[a("td",[s._v("集群中节点宕机")]),s._v(" "),a("td",[s._v("Redis哨兵，健康检测和自动恢复")])])])]),s._v(" "),a("p",[s._v("RDB：Redis database backup file，save “”表示禁用，停机执行bgsave，流程先fork子进程，子进程拷贝主进程数据，其中主进程修改数据时，也先拷贝一份，改完后再同步给子进程。总体来说RDB相当于快照，一趟下来存在很多快照，方便回退。")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1小时1次key修改")]),s._v("\n# save "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n# save "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n# save "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n")])])]),a("p",[s._v("AOF：append only file，开启appendonly yes，默认不开启；everysec，每隔一秒把缓冲区命令执行，数据写到AOF文件")]),s._v(" "),a("p",[s._v("缺点：只要是命令就记，set name zs set name ls 第一次操作没有意义，无需记录")]),s._v(" "),a("p",[s._v("解决：bgrewriteaof，文件大小达到一定大小，自动bgrewriteaof")]),s._v(" "),a("p",[s._v("RDB优点恢复速度快，缺点数据不完整；AOF恢复速度慢，优点数据完整")])])}),[],!1,null,null,null);t.default=v.exports}}]);