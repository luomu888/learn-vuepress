<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>入门篇 | luomu</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="luomu">
    
    <link rel="preload" href="/learn-vuepress/assets/css/0.styles.216a5ded.css" as="style"><link rel="preload" href="/learn-vuepress/assets/js/app.057a2b8d.js" as="script"><link rel="preload" href="/learn-vuepress/assets/js/7.4fee6b00.js" as="script"><link rel="preload" href="/learn-vuepress/assets/js/1.a3f35cab.js" as="script"><link rel="preload" href="/learn-vuepress/assets/js/20.0609e649.js" as="script"><link rel="prefetch" href="/learn-vuepress/assets/js/10.f98da735.js"><link rel="prefetch" href="/learn-vuepress/assets/js/11.909c0978.js"><link rel="prefetch" href="/learn-vuepress/assets/js/12.2bac5d18.js"><link rel="prefetch" href="/learn-vuepress/assets/js/13.20f0b439.js"><link rel="prefetch" href="/learn-vuepress/assets/js/14.9ae294ad.js"><link rel="prefetch" href="/learn-vuepress/assets/js/15.88ea31f3.js"><link rel="prefetch" href="/learn-vuepress/assets/js/16.26aec435.js"><link rel="prefetch" href="/learn-vuepress/assets/js/17.be793736.js"><link rel="prefetch" href="/learn-vuepress/assets/js/18.87fe0efd.js"><link rel="prefetch" href="/learn-vuepress/assets/js/19.d6b74ddf.js"><link rel="prefetch" href="/learn-vuepress/assets/js/21.fcc0b106.js"><link rel="prefetch" href="/learn-vuepress/assets/js/22.54ced2a1.js"><link rel="prefetch" href="/learn-vuepress/assets/js/23.47e9016d.js"><link rel="prefetch" href="/learn-vuepress/assets/js/3.144562e9.js"><link rel="prefetch" href="/learn-vuepress/assets/js/4.ed2bd9b2.js"><link rel="prefetch" href="/learn-vuepress/assets/js/5.e401998d.js"><link rel="prefetch" href="/learn-vuepress/assets/js/6.68b73da4.js"><link rel="prefetch" href="/learn-vuepress/assets/js/8.80faf5c4.js"><link rel="prefetch" href="/learn-vuepress/assets/js/9.2360727d.js">
    <link rel="stylesheet" href="/learn-vuepress/assets/css/0.styles.216a5ded.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>luomu</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>luomu</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">luomu</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/learn-vuepress/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      luomu的 Java 博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/luomu888" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><!----> <!----> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>13</h3> <h6 data-v-39576ba9>文章</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>0</h3> <h6 data-v-39576ba9>标签</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/learn-vuepress/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      luomu的 Java 博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/luomu888" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机底层</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面经</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python学习笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-vuepress/frame/MySQL.html" class="sidebar-link">数据库</a></li><li><a href="/learn-vuepress/frame/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/learn-vuepress/frame/Redis.html" aria-current="page" class="active sidebar-link">Redis</a></li><li><a href="/learn-vuepress/frame/springboot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/learn-vuepress/frame/vue3.html" class="sidebar-link">Vue3</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2></h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2022
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">入门篇</h1> <div data-v-f875f3fc><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="入门篇"><a href="#入门篇" class="header-anchor">#</a> 入门篇</h1> <h2 id="sql和nosql"><a href="#sql和nosql" class="header-anchor">#</a> SQL和NoSQL</h2> <table><thead><tr><th></th> <th>SQL</th> <th>NoSQL</th></tr></thead> <tbody><tr><td>结构</td> <td>结构（主键，外键，自增）</td> <td>非结构化</td></tr> <tr><td>SQL语句</td> <td>是</td> <td>不是</td></tr> <tr><td>存储</td> <td>磁盘</td> <td>内存</td></tr> <tr><td>关联</td> <td>关联（表和表主键有联系，关系型数据库）</td> <td>非关联，非关系型数据库</td></tr> <tr><td>性能</td> <td>不好</td> <td>好</td></tr> <tr><td>安全性，一致性</td> <td>好</td> <td>不好</td></tr></tbody></table> <h2 id="redis特征"><a href="#redis特征" class="header-anchor">#</a> Redis特征</h2> <blockquote><p><code>remote dictionary server</code>（远程字典服务器）</p></blockquote> <ul><li>主从集群、分片集群</li> <li>支持多客户端（Java、c、Python）等</li> <li>原子性</li> <li>内存存储</li> <li>数据持久化（AOF、RDB）</li> <li>键值对
<ul><li>键：多数是字符串</li> <li>值：5种基本数据类型（string，hash，set，sorted-set，list）</li></ul></li></ul> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <ol><li><p>tar -xzf redis-6.2.6.tar.gz</p></li> <li><p>cd redis-6.2.6</p></li> <li><p>make &amp;&amp; make install</p></li> <li><p>修改配置</p> <ul><li><p>cp redis.conf redis.conf.bck</p></li> <li><p>vim redis.conf</p> <div class="language-ini extra-class"><pre class="language-ini"><code>- bind 0.0.0.0
- daemonize yes :后台运行
- requirepass redis：密码redis
</code></pre></div></li></ul></li> <li><p>vi /etc/systemd/system/redis.service</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">redis-server</span>
<span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">network.target</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Type</span><span class="token punctuation">=</span><span class="token value attr-value">forking</span>
<span class="token key attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/bin/redis-server /usr/local/src/redis-6.2.6/redis.conf</span>
<span class="token key attr-name">PrivateTmp</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Install</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">WantedBy</span><span class="token punctuation">=</span><span class="token value attr-value">multi-user.target</span>
</code></pre></div></li> <li><p>systemctl daemon-reload</p></li> <li><p>systemctl enable redis：开机自启</p></li></ol> <h2 id="redis常见命令"><a href="#redis常见命令" class="header-anchor">#</a> Redis常见命令</h2> <blockquote><p><code>luo:user:1 luo:product:1</code>：luo项目下有user和商品表，编号都为1</p></blockquote> <p><code>select</code>0：切换数据库</p> <p><code>TTL</code>：time to life</p> <ul><li>-1：永久</li> <li>-2：失效</li></ul> <p><strong>string</strong>：简单的入门</p> <ul><li><code>setnx</code>：不存在添加，存在什么都不管（和set区别是存在修改）</li></ul> <p><strong>hash</strong>：取到JSON字符串中的字段，修改字段值</p> <ul><li><code>hset key field value</code>：即key下有键值对</li></ul> <p><strong>list</strong>：队列和栈的实现</p> <ul><li>队列：先进先出，两个门（左进右出，右进左出）</li> <li>栈：先进后出，一个门（左进左出，右进右出）</li> <li>lpush lpop rpush rpop</li> <li>blpush blpop</li> <li><code>BLPOP</code>：
<ul><li>B：<code>block</code>阻塞</li> <li>L：<code>left</code>左侧</li></ul></li> <li>语法：key 链表（1 2 3）</li> <li>场景：点赞列表，评论列表</li></ul> <p><strong>set</strong>：好友，朋友的好友和我的好友 相同数</p> <ul><li>交集 sinter</li> <li>差集 sdiff(<code>different</code>)</li> <li>并集 <code>sunion</code></li> <li>语法：key 集合（1 2 3）</li></ul> <p><strong>sortedSet</strong>：类似TreeSet，默认升序排序，可排序，使用场景排行榜</p> <ul><li>zrevrange 0 2：排名前三人数
<ul><li>z的后面添加rev，即降序</li> <li>rev：<code>reverse</code>反转</li></ul></li> <li><code>zrank</code>：查看单个排名</li> <li><code>zscore</code>：查看单个分数</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220712215954448.png" alt="image-20220712215954448"></p> <h2 id="redis的java客户端"><a href="#redis的java客户端" class="header-anchor">#</a> Redis的Java客户端</h2> <p>Jedis：</p> <ul><li>命令操作，</li> <li>线程不安全，使用redis连接池（并发）</li> <li>直接学springdataRedis</li></ul> <p>SpringDataRedis</p> <ul><li><p>依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Redis依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--连接池依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置yaml</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.111.130
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span> <span class="token comment">#最大活跃</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span> <span class="token comment">#最大空闲</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#最小空闲</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token comment">#最大等待时间</span>
</code></pre></div></li> <li><p>普通RedisTemplate：可读性差</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220713210955232.png" alt="image-20220713210955232"></p></li> <li><p>自定义RedisTemplate：多出class字节码，标识那个对象</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220713211037953.png" alt="image-20220713211037953"></p></li> <li><p>解决：注入stringredisTemplate，key、value都是字符串，所以添加前把对象转字符串，获取结果把字符串转对象</p></li> <li><p>ObjectMapper：JSON工具</p> <ul><li>writeValueAsString：对象-&gt;字符串</li> <li>readValue：字符串-&gt;对象</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.codehaus.jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-mapper-asl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <h1 id="企业篇"><a href="#企业篇" class="header-anchor">#</a> 企业篇</h1> <h2 id="redis实现共享token登录"><a href="#redis实现共享token登录" class="header-anchor">#</a> Redis实现共享token登录</h2> <blockquote><p>注意：使用Redis一定要记得设置有效期，否则浪费内存</p></blockquote> <p><code>session</code>配合<code>cookie</code>实现登录：</p> <ol><li><code>session</code>存验证码</li> <li>判断验证码，根据手机号查询用户
<ul><li>用户不存在，创建新用户（无需注册）</li> <li>存在和不存在最后存入<code>session</code>都是数据库存在的</li></ul></li> <li>用户信息存入<code>session</code></li> <li>校验登录，请求携带<code>cookie</code>，cookie中用<code>sessionid</code>，<code>Tomcat</code>自动根据<code>sessionid</code>找到<code>session</code></li> <li>从session中拿到用户信息，判断用户是否存在，没有则拦截</li></ol> <p>session：java代码保存，<code>key</code>自定义，<code>value</code>用户信息
cookie：key是<code>jseesionid</code>value是jseesionid 的值</p> <p>每个session都有一个唯一的sessionid
sessionid自动写到cookie</p> <p>请求时带上自动带上cookie，然后sessionid也跟上，自动找到session</p> <p>Tomcat帮我们处理sessionid自动操作</p> <p>Redis实现共享<code>token</code>登录：</p> <ul><li><p>登录使用session的问题：多台Tomcat不存在session共享</p></li> <li><p>解决：数据共享，内存，key value（hash）-------&gt;<code>Redis</code></p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220714105137508.png" alt="image-20220714105137508"></p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220714093259472.png" alt="image-20220714093259472"></p></li></ul> <p>登录状态：</p> <ul><li><p>用户登录校验使用拦截器，不同controller就不需要单独写校验，拦截器在<code>controller</code>之前执行，统一写到拦截器判断校验</p></li> <li><p>平常注册完后登录状态一直在</p></li> <li><p>没有登录之前拦截请求其他页面，登录后就不管，一直有效，随便访问页面</p></li> <li><p>这次拦截判断登录状态是否有效，一直没有请求其他页面，时间到后需要重新登录</p></li> <li><p>关键是判断<code>ThreadLocal</code>是否有用户，没有用户则拦截请求</p></li> <li><p>一开始登录没有用户，所以第一个不需要拦截，第二个拦截器才需要判断用户是否存在进行拦截</p></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220714104819570.png" alt="image-20220714104819570"></p> <p>技巧：</p> <ul><li><p>拦截器到的用户信息存到threadlocal方便controller使用</p></li> <li><p>401未授权</p></li> <li><p><code>BeanUtil.copyProperties</code>：对象属性填充</p></li> <li><p>使用redis代替session</p></li> <li><p>请求带cookie，cookie带sessionid，根据sessionid找到session</p></li> <li><p>使用token原因：token还需要返回给前端，如果使用手机号用泄露的风险</p></li> <li><p>定义为常量防止之后写错</p></li> <li><p>自定义类不能使用@resource和@Autowire注入，可以使用构造方法注入，然后谁使用该类，把对象传进来</p></li> <li><p>用户信息不能泄露，前端用户信息页面展示只需要少量，所以定义vo类</p></li></ul> <p>@Resource 和 @Autowire区别</p> <table><thead><tr><th></th> <th>resource</th> <th>Autowire</th></tr></thead> <tbody><tr><td>类型</td> <td>byname</td> <td>bytype（接口对应一个实现类使用）</td></tr> <tr><td>指定方式</td> <td>name指定</td> <td>qualifier</td></tr></tbody></table> <p>学完项目token，再去看Javaguide的token</p> <ul><li>权限验证</li> <li>cookie自带sessionid，容易遭到攻击，因为你点击黑客连接，cookie被他拿到</li> <li>而<code>token</code>没有存入cookie，存到会话存储空间</li> <li>http是无状态协议，需要使用cookie和session记录状态</li></ul> <h2 id="查询缓存"><a href="#查询缓存" class="header-anchor">#</a> 查询缓存</h2> <p>速度：CPU&gt;内存&gt;磁盘</p> <p>而CPU需要从内存或磁盘取数据才能执行，所以有了缓存，提前把数据存入到CPU的缓存中，无需重新获取，性能提升</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715182603493.png" alt="image-20220715182603493"></p> <h3 id="redis缓存"><a href="#redis缓存" class="header-anchor">#</a> Redis缓存</h3> <p>浏览器：img图片</p> <p>Tomcat：应用层缓存，redis</p> <p>数据库缓存：索引缓存，索引查询速度快</p> <p>数据库数据最终还是到磁盘或CPU差，所以还有CPU缓存（多级缓存），磁盘缓存</p> <p>缓存数据一致性问题，解决问题需要复杂代码，维护问题，硬件问题</p> <p>缓存也可以不使用，只要你能等，兜底也加<code>TTL</code></p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715183056310.png" alt="image-20220715183056310"></p> <h3 id="redis缓存问题"><a href="#redis缓存问题" class="header-anchor">#</a> Redis缓存问题</h3> <p>更新：</p> <ul><li>自动：内存不足自动淘汰</li> <li>时间到后剔除：设置TTL</li> <li>主动：更新数据库同时，把缓存更新</li></ul> <p>主动策略：</p> <ul><li>修改数据库，把缓存更新，数据库最新</li> <li>修改缓存，异步把数据库更新，缓存最新</li> <li>我什么都不管，我调用服务来解决</li></ul> <p>删除缓存还是更新缓存：删除好，因为数据库可能一直修改，没查询，缓存也跟着更新，导致无效写操作多</p> <p>线程安全问题：先删缓存后操作数据库</p> <ul><li>删除缓存</li> <li>第二个线程查询缓存没有，把数据库10放到缓存</li> <li>第一个线程好了，更新数据库，数据库20，缓存10</li></ul> <p>事务：单体，缓存操作和数据库放到一块</p> <p>先操作数据库，然后删除缓存，操作数据库时间长，删除缓存<code>redis</code>基于内存快，所以数据一致性高</p> <p>不同步原因：缓存失效，查询<code>redis</code>未命中，查询数据库同时，另一个线程更新数据库，删除缓存，写入缓存是第一个查询的老数据</p> <p>写入缓存微妙级别，把数据库更新和缓存删除不太可能（概率低）</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715113717881.png" alt="image-20220715113717881"></p> <p>缓存穿透：请求数据库不存在的值，null，一直请求，都打到数据库，黑客不怀好意访问</p> <ul><li><p>查询数据库不存在，返回<code>&quot;&quot;</code>空值存入<code>redis</code>缓存</p></li> <li><p>布隆过滤：布隆不存在，直接返回</p></li> <li><p>预防：用户权限，参数校验，热点参数限流，id不规则性，防止被猜测</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715201727996.png" alt="image-20220715201727996"></p></li></ul> <p>缓存雪崩：大量key失效</p> <ul><li>设置TTL无规则</li> <li>降级限流</li> <li>多级缓存</li></ul> <p>缓存击穿：缓存失效，重建过程复杂，花费时间长，许多请求</p> <ul><li><p>互斥锁，只能有一个重建</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715201815461.png" alt="image-20220715201815461"></p></li> <li><p>逻辑过期：即拿到锁的重建，其他返回旧数据，添加<code>expire</code>，用于缓存失效重建过程判断缓存还生效（善意的谎言）</p></li> <li><p>注意：缓存没命中，返回空不是旧数据，因为不可能为空，<code>expire</code>一直在，是人工提前设置，活动结束手动删除</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220715201843592.png" alt="image-20220715201843592"></p></li></ul> <p>缓存击穿：关键是自定义的假过期，我传入10秒，10秒后过期</p> <p><code>redisData.getExpireTime().isAfter(LocalDateTime.now())</code>：判断在当前时间后，不在过期，过期，开启独立线程执行数据重建，创建shop和expire载入redis，释放锁，然后返回旧数据，下次进来就可以获取新数据</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithBreakDown</span><span class="token punctuation">(</span><span class="token class-name">String</span> preKey<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span>
                                    <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbCallBack<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token class-name">Shop</span> shop <span class="token operator">=</span> redisCache<span class="token punctuation">.</span><span class="token function">queryWithBreakDown</span><span class="token punctuation">(</span>CACHE_SHOP_KEY<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getById</span><span class="token punctuation">,</span> CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><code>&lt;R,ID&gt;</code>：泛型</p> <p><code>function</code>：函数，不确定类型，由调用者执行函数，</p> <p><code>Class&lt;R&gt; type</code>：指定R的类型</p> <p>布隆存在误判</p> <p>封装工具类：函数编程思想</p> <p>锁有规定id</p> <p>缓存穿透：</p> <ul><li>问题：访问不存在的数据，直接打到<code>Redis</code></li> <li>解决：
<ul><li>第一次，数据库查询为空，然后缓存设置&quot;&quot;，设置时间</li> <li>第二次，访问数据存在，值&quot;&quot;，所以直接返回</li> <li>流程；判断数据是否存在，存在判断是否为&quot;&quot;，否则返回数据；redis为null，查询数据库，数据库为空，缓存设置&quot;&quot;，返回结果&quot;&quot;；否则数据库查出来数据放到redis，返回数据</li></ul></li></ul> <p>缓存雪崩：</p> <ul><li>问题：大量的<code>key</code>同时失效</li> <li>解决：key设置时间无规则；降级限流，热点参数；权限管理</li></ul> <p>缓存击穿：</p> <ul><li>问题：<code>key</code>恰好失效，高并发请求过来，重建数据复杂</li> <li>解决：
<ul><li>互斥锁：redis数据存在，直接返回；不存在，获取锁，获取锁失败，睡眠后重新请求（递归）；获取锁成功，查询数据，把数据写入redis缓存，关闭锁，返回数据</li> <li>逻辑过期：redis数据为命中，返回null，因为活动前人为设置数据，一直存在，假过期，访问不存在，那么就是不存在；redis命中，判断是否过期；未过期返回数据；过期获取锁，获取锁失败，返回旧数据；获取锁成功，开启独立线程，查询数据并设置<code>expire</code>时间，最后添加到<code>Redis</code>缓存，关闭锁，下次访问就存在</li></ul></li></ul> <h2 id="优惠价秒杀-旧"><a href="#优惠价秒杀-旧" class="header-anchor">#</a> 优惠价秒杀（旧）</h2> <blockquote><p>添加特价劵</p> <p>看门狗：库存是否充足，一人一单，订单是否存在</p></blockquote> <p>思路：获取锁，添加线程标识类似主键，给锁设置超时时间，阻塞自动释放锁；没有阻塞执行业务</p> <p>业务：查询优惠价信息，判断秒杀开始和结束时间，库存，优惠券<code>id</code>和用户<code>id</code>判断订单号是否存在</p> <p>释放锁，判断标识是否自己，此时必须保证判断标识和删除<code>key</code>两个动作原子性，所以使用<code>lua</code>脚本</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220717204318686.png" alt="image-20220717204318686"></p> <p>注意订单号问题（重点）：订单号保持许多无规律，所以不能使用主键唯一性，如果没有许多订单号，使用数据库主键自增，不会出现很多超卖问题，可以使用下面规则判断库存，判断订单</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220717164427191.png" alt="image-20220717164427191"></p> <p>具体实现：</p> <ul><li><p>喜欢反向操作，不行直接退出</p></li> <li><p>订单id：生成一个全局唯一<code>id</code></p> <ul><li><p>时间戳=当前时间-前<code>69</code>年</p></li> <li><p>向左移<code>32</code>位，留32位给一天使用</p></li> <li><p>或运算</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 时间戳</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> INIT_TIME<span class="token operator">=</span><span class="token number">1640995200L</span><span class="token punctuation">;</span>
<span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> nowTime <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> l <span class="token operator">=</span> nowTime <span class="token operator">-</span> INIT_TIME<span class="token punctuation">;</span>
<span class="token keyword">long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;incr:&quot;</span> <span class="token operator">+</span> keyPreFix <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> l<span class="token operator">&lt;&lt;</span>DIGIT <span class="token operator">|</span> count<span class="token punctuation">;</span>
</code></pre></div></li></ul></li></ul> <p>集群下：每个<code>jvm</code>都有自己的锁，锁监视器不一样</p> <p><code>redis</code>的<code>setnx</code>分布式锁：</p> <ul><li>问题：线程1获取锁成功，执行业务，业务阻塞，TTL到期，删除锁，第二个线程执行，第一个好了，删除锁，第二个线程还不知道锁被删除，第三个线程来了，看见第一个线程把锁删了，所以第三个 线程也获取锁成功，同时出现了线程2和3执行业务</li></ul> <p>释放锁时被别人锁删除</p> <p>垃圾回收<code>fullGC</code>阻塞所有代码</p> <p>判断和释放锁两个动作，保证两个动作原子性</p> <p>原子性：事务，<code>lua</code>脚本确保原子性</p> <p><code>classpathresource</code></p> <p>分布式锁添加标识，标识成功后进入删除，还没来得及删除锁，阻塞，别人获取锁，网络好了，删除锁，不用重新判断标识，所以要保证标识和删除动作的原子性</p> <p>Redis-lua：一定是<code>KEYS</code>和<code>ARGV</code>大写，小写报错</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">-- 判断标识是否一致</span>
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;del&quot;</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre></div><p>一个用户加一把锁 一个用户不能加多个锁</p> <p><code>userid.toString()</code>，底层tostring方法是<code>new string</code>，所以还不是同一个对象，使用<code>userid.toString().intern()</code></p> <p>事务尚未提交，事务提交后释放锁</p> <p>事务失效：解决，需要拿到事务代理对象<code>AopContext.currentProxy()</code></p> <p>启动类添加代理对象暴露：<code>@EnableAspectJAutoProxy(exposeProxy=true)</code>，添加依赖</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220716132543111.png" alt="image-20220716132543111"></p> <p>不可重入，调用同一把锁，A调用锁，A里面执行B需要调用同一把锁，失败，因为A还在用，B没结束，导致A没结束，死锁</p> <p>功能扩展：概率极低分布式锁优化，可以跳过</p> <p>前面学习是懂原理，面试问，以后开发使用<code>Redis</code>框架<code>redisson</code>，有许多好用的锁</p> <p>redisson：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.111.130:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;redis&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 锁对象</span>
<span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 尝试获取</span>
<span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1200L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 释放</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>秒杀的锁：<code>order:userId</code>
订单id：
key：<code>incr:order:时间戳</code>
value：递增 1 2 3 4 5
最后数据库返回的订单id，<code>L&lt;&lt;digit | value</code>，L左移32位，剩下32给<code>value</code>（一天），L=当前时间戳-69年时间戳</p> <p>商品key：<code>cache:shop:shopid</code></p> <p>自定义的秒杀锁：
key：<code>lock:order:userId</code>
唯一标识<code>value：UUID</code>随机数+当前线程id <code>ThreadID</code></p> <h2 id="优化秒杀-常用"><a href="#优化秒杀-常用" class="header-anchor">#</a> 优化秒杀（常用）</h2> <p>参考登录：数据库把用户取出来，拿到手机号，生成随机<code>token</code>，然后存入Redis</p> <p><code>@PostConstruct</code>：当前类初始化完毕后执行</p> <p>没有消息阻塞<code>BLPOP</code></p> <p><code>xread count 1 streams users 0：</code>
count 1 ：读取数量
streams users：哪个streams，指队列
0：代表从第一个消息开始
$：代表从最新消息开始，中间漏读</p> <p>// 创建组，队列stream.orders
<code>xgroup create stream.orders g1 0 mkstream</code></p> <ul><li>stream.orders ：队列</li> <li>g1：组</li></ul> <p>// 添加消费者
<code>xgroup createconsumer stream.orders g1 c1</code></p> <ul><li>stream.orders ：队列</li> <li>g1：组</li> <li>c1：消费者</li></ul> <p>最完整的秒杀流程：</p> <blockquote><p>思路：执行脚本，脚本返回值0 1 2 ，为0则直接返回订单id；类启动初始化完成后，使用@PostConstruct标注的方法立刻执行，所以里面独立线程调用预处理订单方法；预处理指从消息队列获取订单消息，判断是否存在，存在创建订单（调用真正和数据库打交道的方法，即库存-1，保存订单记录.），确认消息执行；异常执行另一个方法，从pending-list获取消息，使用0，获取最初未被消费和确认消息；创建订单：获取锁对象，尝试获取锁，判断订单是否存在数据库，不存在，扣减库存，保存订单</p></blockquote> <ul><li><p>开启独立线程</p></li> <li><p>@PostConstruct：在类初始化完成后执行</p></li> <li><p>获取消息队列订单消息，创建订单，执行xack确认消息被消费，异常的话重新执行</p> <ul><li>创建一个新方法执行（对）：使用<code>streams stream.orders 0</code>，遗漏的消息，即pending-list中的第一个消息</li> <li>递归调用本方法（错）：使用<code>streams stream.orders &gt;</code>  下一个未消费消息</li></ul></li> <li><p>创建订单：</p> <ul><li>用户id，秒杀券id</li> <li>获取锁对象，尝试获取锁</li> <li>查询订单是否存在</li> <li>不存在扣减库存，保存订单</li> <li>释放锁</li></ul></li> <li><p>获取用户id，随机订单id</p></li> <li><p>执行lua脚本</p></li> <li><p>获取结果，判断结果 0可以返回订单id，还没操作数据库，只是立刻返回，独立线程执行数据库；否则库存不足或不能重复下单</p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220719114417013.png" alt="image-20220719114417013"></p> <p><img src="https://cdn.jsdelivr.net/gh/luomu888/cloudimg@master/img2/image-20220719204132290.png" alt="image-20220719204132290"></p></li> <li><p><code>seckill.lua</code>：</p> <ul><li>参数：优惠券id，用户id，订单id</li> <li>key：库存key，订单key</li> <li>判断库存是否充足</li> <li>判断用户是否下单</li> <li>扣库存（Redis）</li> <li>下单（保存用户信息到redis）</li> <li>发送消息到队列</li></ul></li></ul> <p><code>setSql(&quot;stock=stock-1&quot;)</code></p> <p>-- 2.数据key</p> <p>-- 2.1.库存key</p> <p><code>local stockKey = 'seckill:stock:' .. voucherId</code></p> <p>-- 2.2.订单key</p> <p><code>local orderKey = 'seckill:order:' .. voucherId</code></p> <h2 id="点赞"><a href="#点赞" class="header-anchor">#</a> 点赞</h2> <blockquote><p>后端点赞控制主要是<code>isLike</code>字段，<code>true</code>点赞，<code>false</code>未点赞</p> <p>点赞功能：添加多个表，记录点赞用户（操作数据库，太重了）</p> <p>解决：<code>redis</code>，点赞集合，<code>set</code>，集合存用户id，唯一性</p></blockquote> <p>发表博客：</p> <ul><li><code>post</code>请求</li> <li>参数实体类，<code>@RequestBody</code></li></ul> <p>图片上传：<code>multipartfile</code>多部分文件</p> <ol><li><code>getOriginalFilename</code>：获取文件原始名称</li> <li>生成新文件名，方便统一管理：自定义方法实现</li> <li><code>transferTo</code>：保存图片到本地磁盘，即<code>nginx</code>下的项目</li> <li>返回结果</li></ol> <p>实体类：字段可以多不可以少</p> <p>博客类：包含用户id，名字，图片（userDTO），字段设置不存在</p> <p>根据博客id查询博客</p> <ul><li>注意：博客存在，展示需要查询博客底下相关用户，是否被点赞</li> <li>点赞key：<code>BLOG_LIKED_KEY+blogId</code></li> <li><code>field</code>字段：<code>userID</code>值</li> <li><code>score</code>：时间戳</li></ul> <p>根据博客查询博客用户<code>queryBlogUser(Blog blog)</code></p> <ol><li>取出博客用户id</li> <li>根据用户id查询用户</li> <li>设置博客关于用户的字段</li></ol> <p>根据博客类判断用户是否点赞<code>isBlogLiked(Blog blog)</code></p> <ol><li>获取当前用户</li> <li>获取用户id</li> <li>拼接key，查询redis的<code>score</code>值是否存在</li></ol> <p>当前用户点赞控制，点过在点-1：</p> <ul><li>获取当前用户id</li> <li>查询Redis的score值</li> <li>值为空，点赞，存入Redis</li> <li>不为空，点赞数量-1，Redis删除</li></ul> <p>获取点赞用户前5：</p> <ul><li>Redis的<code>range</code>查询前5的blog</li> <li>解析结果中的用户id</li> <li>遍历每个id查询用户</li> <li>设置每个<code>userDTO</code></li> <li>返回userDTO集合</li></ul> <p>注意：更新数据库，需要调用两次<code>update</code>方法</p> <h2 id="关注"><a href="#关注" class="header-anchor">#</a> 关注</h2> <p>in(3,1)：1，3数据库id排序有问题；使用<code>order bt field(id,5,1)</code>，order by field(id,ids)，保证新发布显示在前</p> <p>是否关注：</p> <ul><li>获取用户id</li> <li>根据用户<code>id、followid</code>查询是否关注</li></ul> <p>关注：Redis数据库类型使用set</p> <ul><li>用户id</li> <li><code>key：follows:+userId</code></li> <li>关注：
<ul><li>新增数据</li> <li>保存到Redis，<code>value：followID</code></li></ul></li> <li>取关：
<ul><li>根据用户id和跟随id删除数据库</li> <li>删除Redis</li></ul></li></ul> <p>新增博客</p> <ul><li>获取当前用户</li> <li>博客设置用户id字段后保存到数据库</li> <li>根据用户id查询所有粉丝</li> <li>用户粉丝id（实际是另一个用户id）</li> <li>保存到Redis，<code>key=feed_key+userId，field博客id，value时间戳</code></li> <li>返回博客id</li></ul> <p>查询共同关注：</p> <ul><li>用户id</li> <li><code>key1=&quot;follows&quot;+userId</code></li> <li><code>key2=&quot;follows&quot;+id</code>，该id是查询某个用户id（实际也是用户id）</li> <li>求交集</li> <li>解析结果</li> <li>返回<code>userDTO</code>集合</li></ul> <p>拉：消息放到up住，粉丝要在拉过去，用完丢，要的时候在拉</p> <p>推模式；直接把文章推送到用户，例微信公众号，读取延迟低</p> <p>推拉模式：热点粉丝推，普通粉丝拉模式，拉模式读取延迟高</p> <p>使用推：没有大V</p> <p>数据有变化，排行榜，朋友圈消息，角标使用<code>sortedSet</code>，不使用list</p> <p>offset要跳过上次查询第几个和最小一样的</p> <p><code>@RequestParam，defaultValue=“0”，require=false</code>，代表参数也可以没有</p> <p>请求方式 请求路径 请求参数 返回值</p> <p>滚动分页查询：</p> <ul><li>当前用户</li> <li>查询Redis收件箱：<code>ZREVRANGEBYSCORE key Max Min LIMIT offset count</code></li> <li>解析数据：偏移量、时间戳</li> <li>遍历所有博客，查询跟博客相关点赞用户，查询是否被点赞</li> <li>封装到<code>ScrollResult</code>并返回</li></ul> <h2 id="附近商户"><a href="#附近商户" class="header-anchor">#</a> 附近商户</h2> <blockquote><p>算法，所有实现<code>geo</code>底层原理：将经纬度转换为二进制的数字，利用某种编码转换成对应字符串</p></blockquote> <p>是不是得提前把距离数据存入Redis：是，需要在测试类中提前添加</p> <p>查询店铺类型+坐标：</p> <ul><li>判断是否需要坐标</li> <li>from、end：分页参数</li> <li><code>key：SHOP_GEO_KEY+typeID</code></li> <li>距离5000，limit(end)</li> <li>截取from~end：<code>stream().skip(from).forEach(result-&gt;)</code></li> <li>map：键店铺id，值<code>distance</code></li> <li>返回shops集合</li></ul> <h2 id="签到"><a href="#签到" class="header-anchor">#</a> 签到</h2> <p>签到：</p> <ul><li>当前用户id</li> <li>当前日期</li> <li><code>key=USER_SIGN_KEY+userId+keySuffix</code>（日期）</li> <li>获取本月的第几天</li> <li>写入Redis</li></ul> <p>本月签到数量：</p> <ul><li>用户id</li> <li><code>key=USER_SIGN_KEY+userId+keySuffix</code>（日期）</li> <li>获取本月的第几天</li> <li><code>BITFIELD sign:5:202203 GET u14 0</code></li> <li>获取结果第一位</li> <li>遍历</li></ul> <h2 id="uv"><a href="#uv" class="header-anchor">#</a> UV</h2> <blockquote><p><code>UV(unique visitor)</code>：独立访客量，一个用户一个</p> <p><code>PV(page view)</code>：页面访问量，刷新当前页面访问量+1</p> <p><code>HyperLogLog</code>：存储内容大小永远小于16kb，小于0.81%误差，内存低到令人发指！</p></blockquote> <ul><li>准备大小1000数组</li> <li>遍历1000000一百万</li> <li>到1000覆盖之前数组，即下标从0开始</li> <li>Redis统计数量</li></ul> <h1 id="高级篇"><a href="#高级篇" class="header-anchor">#</a> 高级篇</h1> <h2 id="分布式缓存"><a href="#分布式缓存" class="header-anchor">#</a> 分布式缓存</h2> <p>单点Redis问题：</p> <table><thead><tr><th>问题</th> <th>解决</th></tr></thead> <tbody><tr><td>内存存储上限</td> <td>分片集群，插槽机制</td></tr> <tr><td>数据丢失</td> <td>持久化AOF和RDB</td></tr> <tr><td>并发</td> <td>主从集群，读写分离</td></tr> <tr><td>集群中节点宕机</td> <td>Redis哨兵，健康检测和自动恢复</td></tr></tbody></table> <p>RDB：Redis database backup file，save “”表示禁用，停机执行bgsave，流程先fork子进程，子进程拷贝主进程数据，其中主进程修改数据时，也先拷贝一份，改完后再同步给子进程。总体来说RDB相当于快照，一趟下来存在很多快照，方便回退。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 1小时1次key修改</span>
# save <span class="token number">3600</span> <span class="token number">1</span>
# save <span class="token number">300</span> <span class="token number">100</span>
# save <span class="token number">60</span> <span class="token number">10000</span>
</code></pre></div><p>AOF：append only file，开启appendonly yes，默认不开启；everysec，每隔一秒把缓冲区命令执行，数据写到AOF文件</p> <p>缺点：只要是命令就记，set name zs set name ls 第一次操作没有意义，无需记录</p> <p>解决：bgrewriteaof，文件大小达到一定大小，自动bgrewriteaof</p> <p>RDB优点恢复速度快，缺点数据不完整；AOF恢复速度慢，优点数据完整</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/learn-vuepress/frame/nginx.html" class="prev">
            Nginx
          </a></span> <span class="next"><a href="/learn-vuepress/frame/springboot.html">
            SpringBoot
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#sql和nosql" class="sidebar-link reco-side-sql和nosql" data-v-cb1513f6>SQL和NoSQL</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#redis特征" class="sidebar-link reco-side-redis特征" data-v-cb1513f6>Redis特征</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#安装" class="sidebar-link reco-side-安装" data-v-cb1513f6>安装</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#redis常见命令" class="sidebar-link reco-side-redis常见命令" data-v-cb1513f6>Redis常见命令</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#redis的java客户端" class="sidebar-link reco-side-redis的java客户端" data-v-cb1513f6>Redis的Java客户端</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#redis实现共享token登录" class="sidebar-link reco-side-redis实现共享token登录" data-v-cb1513f6>Redis实现共享token登录</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#查询缓存" class="sidebar-link reco-side-查询缓存" data-v-cb1513f6>查询缓存</a></li><li class="level-3" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#redis缓存" class="sidebar-link reco-side-redis缓存" data-v-cb1513f6>Redis缓存</a></li><li class="level-3" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#redis缓存问题" class="sidebar-link reco-side-redis缓存问题" data-v-cb1513f6>Redis缓存问题</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#优惠价秒杀-旧" class="sidebar-link reco-side-优惠价秒杀-旧" data-v-cb1513f6>优惠价秒杀（旧）</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#优化秒杀-常用" class="sidebar-link reco-side-优化秒杀-常用" data-v-cb1513f6>优化秒杀（常用）</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#点赞" class="sidebar-link reco-side-点赞" data-v-cb1513f6>点赞</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#关注" class="sidebar-link reco-side-关注" data-v-cb1513f6>关注</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#附近商户" class="sidebar-link reco-side-附近商户" data-v-cb1513f6>附近商户</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#签到" class="sidebar-link reco-side-签到" data-v-cb1513f6>签到</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#uv" class="sidebar-link reco-side-uv" data-v-cb1513f6>UV</a></li><li class="level-2" data-v-cb1513f6><a href="/learn-vuepress/frame/Redis.html#分布式缓存" class="sidebar-link reco-side-分布式缓存" data-v-cb1513f6>分布式缓存</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/learn-vuepress/assets/js/app.057a2b8d.js" defer></script><script src="/learn-vuepress/assets/js/7.4fee6b00.js" defer></script><script src="/learn-vuepress/assets/js/1.a3f35cab.js" defer></script><script src="/learn-vuepress/assets/js/20.0609e649.js" defer></script>
  </body>
</html>
